<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BLE Duplex-Feel Client</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; max-width: 800px; }
    .row { display: flex; gap: 8px; margin: 8px 0; }
    input[type="text"] { flex: 1; padding: 6px; }
    textarea { width: 100%; height: 160px; }
    button { padding: 6px 12px; }
    pre { background:#f6f6f6; padding:10px; overflow:auto; }
  </style>
</head>
<body>
  <h1>ESP32 â†” Browser (Web Bluetooth)</h1>

  <div class="row">
    <button id="btnConnect">Connect</button>
    <button id="btnDisconnect" disabled>Disconnect</button>
  </div>

  <div class="row">
    <input id="outMsg" type="text" placeholder="Type message..." />
    <button id="btnSend" disabled>Send</button>
  </div>

  <h3>Incoming</h3>
  <textarea id="inBox" readonly></textarea>

  <h3>Log</h3>
  <pre id="log"></pre>

<script>
// Must match your ESP32 sketch UUIDs
const SERVICE_UUID           = '12345678-1234-1234-1234-1234567890ab';
const TX_CHARACTERISTIC_UUID = 'abcd1234-5678-90ab-cdef-1234567890ab'; // ESP32->Browser (Notify)
const RX_CHARACTERISTIC_UUID = 'abcd1234-5678-90ab-cdef-1234567890ac'; // Browser->ESP32 (Write)

let device, server, service, txChar, rxChar;
let writeNoRsp = false;

const $ = (id) => document.getElementById(id);
const log = (m) => { $('log').textContent += m + "\\n"; };

function enc(s){ return new TextEncoder().encode(s); }
function dec(b){ return new TextDecoder().decode(b); }

async function connect(){
  try{
    device = await navigator.bluetooth.requestDevice({
      filters: [{ services:[SERVICE_UUID] }],
      optionalServices:[SERVICE_UUID]
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);

    server = await device.gatt.connect();
    service = await server.getPrimaryService(SERVICE_UUID);

    // Notifications from ESP32
    txChar = await service.getCharacteristic(TX_CHARACTERISTIC_UUID);
    await txChar.startNotifications();
    txChar.addEventListener('characteristicvaluechanged', e => {
      const v = new Uint8Array(e.target.value.buffer);
      $('inBox').value += dec(v) + "\\n";
    });

    // Writes to ESP32
    rxChar = await service.getCharacteristic(RX_CHARACTERISTIC_UUID);
    writeNoRsp = !!(rxChar.properties && rxChar.properties.writeWithoutResponse);

    $('btnDisconnect').disabled = false;
    $('btnSend').disabled = false;
    log("Connected. writeWithoutResponse=" + writeNoRsp);
  }catch(err){
    log("Connect error: " + err.message);
  }
}

async function disconnect(){
  try{ if(device && device.gatt.connected) device.gatt.disconnect(); }catch{}
}

function onDisconnected(){
  $('btnDisconnect').disabled = true;
  $('btnSend').disabled = true;
  log("Disconnected.");
}

async function send(){
  const t = $('outMsg').value;
  if(!t) return;
  try{
    const data = enc(t);
    if(writeNoRsp && rxChar.writeValueWithoutResponse){
      await rxChar.writeValueWithoutResponse(data);
    }else{
      await rxChar.writeValue(data);
    }
  }catch(err){
    log("Write error: " + err.message);
  }
}

$('btnConnect').onclick = connect;
$('btnDisconnect').onclick = disconnect;
$('btnSend').onclick = send;
</script>
</body>
</html>
